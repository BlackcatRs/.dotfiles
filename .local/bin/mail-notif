#!/usr/bin/env bash

# Save the last execution time
LAST_MU_SYNC=$(date +"%Y-%m-%dT%H:%M:%S")

# Run only if no other mu is running
pgrep -x mu >/dev/null || mu index 

# Runs only once 
if [ ! -f /tmp/last_mail_check ]; then
    # echo $(uptime -s | sed -r 's/ /T/g') > /tmp/last_mail_check
    echo $LAST_MU_SYNC > /tmp/last_mail_check
    NB_NEW_MAILS=$(mu find flag:new --skip-dups 2>/dev/null | wc -l)
    /usr/bin/dunstify -u normal "Received $NB_NEW_MAILS new mails"
    exit
fi

# Check for recently received mails
read -r LAST_MAIL_CHK < /tmp/last_mail_check
NEW_MAILS=$(mu find flag:new -f "f|s|d" --skip-dups date:$LAST_MAIL_CHK..now 2>/dev/null)

# Alert user
NB_NEW_MAILS=$([ -z "$NEW_MAILS" ] && echo "0" || echo "$(echo "$NEW_MAILS" | wc -l)")
if [ $NB_NEW_MAILS -gt 0 ]; then
    echo "$LAST_MU_SYNC" > /tmp/last_mail_check

    while IFS= read -r mail
    do
	# SENDER_MAIL=$(echo "$mail" | cut -d "|" -f 1 | grep -o -P '(?<=\<).*(?=\>)')
	SENDER=$(echo "$mail" | cut -d "|" -f 1)
	SUBJ=$(echo "$mail" | cut -d "|" -f 2)
	DATE=$(echo "$mail" | cut -d "|" -f 3)

	/usr/bin/dunstify -u normal "$SENDER" "$SUBJ"
	
    done < <(printf '%s\n' "$NEW_MAILS")
fi
